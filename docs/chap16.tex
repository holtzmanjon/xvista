\chapter{Stellar Photometry}
\begin{rawhtml}
<!-- linkto photometry.html -->
\end{rawhtml}

%
% very little editing and some minor reformatting
% used verbatim environment for script examples
% keyword checking only for non-DAOPHOT routines, and none of that
% is 100% guaranteed as there is stuff in the sources that is not
% here and I don't know what they do (Jon: help!)
% rwp/osu 98Jul26
%

\index{Photometry file!Details}
\index{Brightnesses of stars!Introduction}

VISTA has a package of programs designed to measure stellar brightnesses on
CCD pictures. Many of these are taken from the DAOPHOT stellar photometry
package originally written by Peter Stetson. Some additional routines are
included for interaction with the video display and some modifications have
been made to the DAOPHOT routines. The various DAOPHOT programs estimate
the total counts in each star on a frame -- no attempt is made to convert
these counts to magnitudes on some standard system. Some additional
routines are included to help with this transformation.

The version of DAOPHOT which is included in VISTA is an adaptation of
Stetson's 1987 version of the code. Subsequently, Stetson has made
modifications to the standard distribution of DAOPHOT which are NOT
included in the VISTA package. In addition, some modification of the
original DAOPHOT code was necessary to make it work inside of VISTA.
Several new options were added as well by Jon Holtzman. Because of these
facts, Stetson can NOT be help responsible for any results that come out of
the VISTA/DAOPHOT routines. From extensive use of the code, we feel the
routines are reliable, but this cannot be absolutely guaranteed. We are
very grateful to Peter Stetson for allowing us to incorporate his code.

If you wish to use a Stetson's up-to-date version of DAOPHOT, contact him
for the source code, and simply use VISTA to write out the data in some
format which the standalone DAOPHOT can read.

Any questions about the VISTA/DAOPHOT routines should be addressed to the
VISTA distributors and not to Stetson. Publications using the VISTA/DAOPHOT
routines should give credit both to VISTA and to Stetson but remember, he
cannot be help responsible for the results.

The inclusion of DAOPHOT is new to VISTA Version 4. Some of the old VISTA
commands have been discarded because they are less accurate and rather
difficult to make portable.  Gone are FITSTAR, PSF, and BFITSTAR, the old
VISTA routines used for point spread function fitting (although note there
is now a new command FITSTAR which does something entirely different,
namely fits for extinction and transformation coefficients given observed
and standard photometry).

The DAOPHOT routines are discussed below (or CTRL-C out of this and type
HELP DAOPHOT if you are on a terminal and want to skip straight to the
DAOPHOT information). Generally, extensive information on the DAOPHOT
routines is NOT given in this manual. Consult the DAOPHOT manual for more
details.

Besides the DAOPHOT routines, VISTA has two routines to find stellar
objects in a given field, MARKSTAR and AUTOMARK. MARKSTAR is extremely
useful, as it allows the user to interactively enter stars, display stars
in a photometry list, and access information about a star specified with
the cursor on the display. Positions are found by interactively marking
stars. The stored position is computed by centroiding around the cursor
location. AUTOMARK finds objects automatically in a similar way, without
any help from the user. It requires a range of peak values as input which
is uses to decide what are stars.

Aperture brightnesses in circular apertures can be measured quickly using
APERSTAR, which total counts in an aperture of specified size around all
stars on a photometry list. More sophisticated aperture photometry is
available in DAOPHOT using the PHOTOMETRY command.

VISTA includes several commands for the processing of instrumental
magnitudes: COMBINE lets one combine lists of stars from several frames,
MAGAVER computes the weighted mean and other statistics from output from
COMBINE, and FITSTAR allows one to get extinction and transformation
coefficients. The routines REGISTER and OFFSET allow one to determine the
linear plate coefficients from the positions of stars on different frames
and to correct the DAOPHOT files for these plate transformations. 

Most of the programs use a \textbf{photometry file}.  
This is a series of records
which contain information about the location, brightness, and type of
observation for each star.  There is one record per star. The photometry
file is \textbf{not} currently used by the DAOPHOT routines.

\begin{example}
  \item[PRINT PHOT {[BRIEF]}\hfill]{prints the information contained in
       the photometry file.  The output of this can be redirected.}
  \item[SAVE PHOT=file\hfill]{}

  \item[GET PHOT=file\hfill]{saves (or retrieves) VISTA photometry
       files from the disk.}

  \item[SAVE DAO=file\hfill]{}

  \item[GET DAO=file \hfill]{saves (or retrieves) DAOPHOT style photometry
       files from the disk.}

  \item[MODPHOT\hfill]{allows you to enter a name and/or the
       celestial coordinates for entries in a photometry file.}
\end{example}
The VISTA photometry file is stored internally in the VISTA program as a
common block.  It is NOT automatically written to the disk. You have to
save the results you make with the photometry routines using the SAVE
command. Similarly, you can connect a photometry file to the program with
the GET command. The photometry files are stored in the data directory (See
PRINT DIRECTORIES) with the extension .PHO, unless you specify otherwise
(DAOPHOT files have default extension .COO).  If you are using the DAOPHOT
routines, all results are stored in disk files just as in standalone
DAOPHOT.

Some additional commands:
\begin{example}
  \item[COORDS\hfill]{does a coordinate solution for the stars
on a frame, producing right ascension and declination.}
  \item[PHOTONS\hfill]{which adds noise or artificial stars
to a frame, to calibrate your photometry
or for experiments on the accuracy of photometry.}
\end{example}
The operation and limitations of each commands is explained in
the section of the help file for that command. 


\section{DAOPHOT: A Stellar Photometry Package}
\begin{rawhtml}
<!-- linkto daophot.html -->
\end{rawhtml}
\index{Photometry!DAOPHOT}
\index{DAOPHOT}

Starting in VISTA Version 4, the package DAOPHOT, written by Peter Stetson
(Dominion Astrophysical Observatory), has been included to facilitate image
interaction and a common file storage system. Generally, the original
DAOPHOT commands have been changed as little as possible. Consequently,
many of the fancy features of VISTA cannot be interfaced with the DAOPHOT
routines.  For example, DAOPHOT images always have origin (1,1) while VISTA
can handle arbitrary image limits. For the most part, however, the
interface is straightforward to use. All of the DAOPHOT routines which
require a file with image data in standalone DAOPHOT now require a buffer
number with the image in memory. All of the photometry output data is
stored in disk files exactly as DAOPHOT always stores it. See the DAOPHOT
manual for all the details. Not all of the DAOPHOT routines are
implemented.

We have found that interfacing DAOPHOT with VISTA is extremely convenient
because several command line interfaces were created. In many routines,
keywords have been implemented for the DAOPHOT commands that require
keyboard input, facilitating running things in procedures and batch. In
addition, a facility has been provided for providing hard wired default
file names for use with the DAOPHOT routines. If the various photometry
files (.COO, .AP, .MAG, .GRP, .NST, etc.) are previously specified with the
DAOFILES command, the DAOPHOT routines will not prompt the user for
entries, but will rather use the appropriate file as specified with the
DAOFILES command. This is immensely useful for writing VISTA procedures to
do whole chunks of the reduction process as painlessly as possible.

The version of DAOPHOT which is included in VISTA is an adaptation of
Stetson's 1987 version of the code. Subsequently, Stetson has made
modifications to the standard distribution of DAOPHOT which are NOT
included in the VISTA package. In addition, some modification of the
original DAOPHOT code was necessary to make it work inside of VISTA.
Several new options were added as well by Jon Holtzman. Because of these
facts, Stetson can NOT be help responsible for any results that come out of
the VISTA/DAOPHOT routines. From extensive use of the code, we feel the
routines are reliable, but this cannot be absolutely guaranteed. We are
very grateful to Peter Stetson for allowing us to incorporate his code.

If you wish to use a Stetson's up-to-date version of DAOPHOT, contact him
for the source code, and simply use VISTA to write out the data in some
format which the standalone DAOPHOT can read.

Any questions about the VISTA/DAOPHOT routines should be addressed to the
VISTA distributors and not to Stetson. Publications using the VISTA/DAOPHOT
routines should give credit both to VISTA and to Stetson but remember, he
cannot be help responsible for the results.

I leave the full description of all the DAOPHOT commands to the DAOPHOT
manual. Here, I summarize the available DAOPHOT commands (HELP is available
for these in a very limited way): OPTIONS, FIND, PHOTOMETRY, GROUP, PSF,
PEAK, NSTAR, SUB* MONITOR, NOMONITOR, SORT, OFFSET, SELECT, APPEND, DAOSKY,
and DUMP.


\section{OPTIONS: Daophot OPTIONS Command}
\begin{rawhtml}
<!-- linkto options.html -->
\end{rawhtml}
\begin{command}
  \item[Form: OPTIONS {[op=value]} \hfill]{}
  \item[op]{specifies the two letter code for the option}
  \item[im]{specifies the value to set the parameter to}
\end{command}

Allows user to change DAOPHOT options. 
The command OPTIONS by itself will put the
user into interactive options mode, where OPTIONS are changed just as they
are in standard DAOPHOT. If DAOFILES FILE=file.opt is specified before
calling options, OPTIONS will automatically load the options from file.opt
and exit; this is useful for batch use. Finally, OPTIONS opt1=val1
opt2=val2 ..., can be used to change the values of the specified options
opt1, opt2, etc, on the command line; this is probably the preferred mode
of use. In all cases, the options can be specified using the first
two letters of the full names listed below

The different options, along with the preset defaults, are:
\begin{tabular}{rcrrcr}
             FWHM OF OBJECT&=&    2.50&                FITTING RADIUS&=&2.00\\
                 PSF RADIUS&=&   11.00&                WATCH PROGRESS&=&1.00\\
  LS (LOW SHARPNESS CUTOFF)&=&    0.20&    HS (HIGH SHARPNESS CUTOFF)&=&1.00\\
  LR (LOW ROUNDNESS CUTOFF)&=&   -1.00&    HR (HIGH ROUNDNESS CUTOFF)&=&1.00\\
    MAXIMUM GOOD DATA-VALUE&=&32766.50&                       PKRATIO&=&1.00\\
                 WEIGHTEXPO&=&    8.00&                      NOWEIGHT&=&0.00\\
                   SEPRATIO&=&    1.00&                        WRATIO&=&1.00\\
                      APPSF&=&    0.00&                          ISKY&=&0.00\\
                   IPSFMODE&=&    1.00&                          IFIT&=&0.00\\
                       NGAU&=&    1.00&                        INTERP&=&1.00\\
                     IGROUP&=&    0.00&                          IADD&=&0.00\\
                      NPBOX&=&    2.00&                         DIFFM&=&-1.00\\
             LOCK POSITIONS&=&    0.00&                         IMODE&=&0.00\\
                   CHIRATIO&=&    0.00&
\end{tabular}

FWHM is used by FIND; FITTING RADIUS by MULTISTAR; PSF RADIUS by PSF and
MULTISTAR; WATCH by most routines; LS, HS, LR, HR by FIND; MAXIMUM GOOD by
many routines; PKRATIO, WEIGHTEXPO, SEPRATIO, WRATIO, CHIRATIO, ISKY, IFIT by 
MULTISTAR; APPSF, NGAU, NPBOX by PSF.

For most commands, the desired options can be specified on the command line
of the relevant command, making the OPTIONS command obsolete. We are still
working on full implementation of this, however.

\section{FIND: DAOPHOT FIND Command}
\begin{rawhtml}
<!-- linkto find.html -->
\end{rawhtml}
\begin{command}
  \item[Form: FIND dum im {[THRESH=th]} {[LOWBAD=low]} {[INT]}\hfill]{}
  \item[dum]{specifies a dummy buffer}
  \item[im]{specifies the buffer in which to find stars}
\end{command}

Finds stars in buffer \textit{im} over a local threshold value. 
The threshold and low bad pixel value can be set
with the THRESH= and LOWBAD= keywords, or else they will be prompted for in
the normal DAOPHOT fashion. If THRESH= is specified, program won't ask user
to confirm (or change) the value of THRESH after finding stars unless the INT keyword is
also used. The program will prompt for a file in which to store the
coordinates unless the command DAOFILES COO=file has been previously
issued, in which case the coordinates will be stored automatically in the
specified file.

FIND attempts to find objects which have a FWHM similar to that specified by
the FWHM option by convolving the image with a gaussian of the specified
FWHM before looking for objects (see the DAOPHOT manual and/or the source
code for more precise details). After finding objects, some simple image
statistics are computed for each object called SHARP and ROUND. SHARP measures
the ``peakiness'' of the object and has values between 0 (not sharp) and
2 (very sharp). ROUND measures the azimuthal symmetry of an object and has
values between -2 and 2. Only objects with SHARP and ROUND between the
allowed values specified by the options LS/HS and LR/HR are taken as final
detections.

\section{PHOTOM: DAOPHOT APERTURE PHOTOMETRY Command}
\begin{rawhtml}
<!-- linkto photom.html -->
\end{rawhtml}
\begin{command}
  \item[Form: PHOTOMETRY im {[BATCH]} {[RAD=]} {[GAIN=]} {[RN=]} {[SKY=]} {[SKYINT]} {[MEAN]} {[SKYRAD=r1,r2]}\hfill]{}
  \item[im]{specifies the buffer number}
\end{command}

Does aperture photometry on buffer \textit{im} using input star file.  Unlike
standalone DAOPHOT, a photometry table which gives aperatures, etc., is not
used.  The user can specify pixel radii (up to 30 different
values) with the RAD= keyword to give the desired radii for aperture
photometry. The GAIN= and RN= keywords need to be
used to give proper error estimates. With the RAD= keyword, the SKY is
assumed to be 0 unless it a sky value is supplied with the SKY= keyword, or 
unless two annulus radii are specified with the SKYRAD= keyword 
(which is the normal mode of operation).  A series of
aperture radii in an aritmetic progression can be specified in shorthand using
RAD=-naper,startaper,deltaaper (note that this format is recognized by a
NEGATIVE naper), where naper is the desired total number of apertures,
startaper is the size of the first aperture, and deltaaper is the amount
added to the previous aperture size.

The keyword SKY= can be used to set a sky value, used for all stars. Normally,
however, one wishes to allow for possible background variations across
the frame, and a sky value is computed from an annulus around each object;
the size of the annulus is specified using the SKYRAD=r1,r2 keyword.
The default mode of operation uses the DAOPHOT MMM routine to compute a
sky value based on an estimate of the mode of the distribution within the
sky annulus. Alternatively, the
keyword MEAN forces a mean sky value to be used,  and the 3SIG keyword
computes an iterated mean with 3-sigma rejection.
The keyword SKYINT will
compute a sky value for each star, then prompt the user to enter a desired 
value for each star. 

\section{GROUP: DAOPHOT GROUP Command}
\begin{rawhtml}
<!-- linkto group.html -->
\end{rawhtml}
\begin{command}
  \item[Form: GROUP {[CRIT=crit]}\hfill]{}
  \item[GROUP]{Groups stars according to user specified PSF overlap}
  \item[OLDGROUP]{Groups stars in the old DAOPHOT way, just by distances
to neighbors}
\end{command}

GROUP splits stars into separate groups for possible use during the
PSF-fitting procedure. OLDGROUP (or GROUP with option IGROUP=1) splits
stars just on the basis of the distance to the nearest neighbor, and
needs a critical separation as input. GROUP
(with option IGROUP=0) uses brightness information and information about
the PSF as well, and uses a critical brightness ratio as input.

GROUP uses as input an output file from
the PHOTOMETRY command. The program will prompt for a critical separation or
critical ratio, or it can be specified with the CRIT= keyword.  The command will
also prompt for an input aperture photometry file, an output group file,
and a PSF file (for GROUP IG=0).  Alternatively, these files can
be specified with the DAOFILES MAG=magfile GRP=grpfile PSF=psffile command.

\section{PSF: DAOPHOT PSF Command}
\begin{rawhtml}
<!-- linkto psf.html -->
\end{rawhtml}
\begin{command}
  \item[Form: PSF im {[STARS=s1,s2,...]} {[INT]}\hfill]{}
  \item[im]{specifies the buffer number}
\end{command}

Creates a DAOPHOT style PSF from specified stars in buffer \textit{im}. 
The program
will prompt for stars to use unless they are specified with the STARS=
keyword. If this keyword is used, the stars will automatically be accepted
(no user final verification) unless the INT keyword is also
specified. The program will prompt for an input aperture magnitude file and
an output PSF file name unless these have been previously specified with
the DAOFILES MAG=magfile PSF=psffile command.

A DAOPHOT PSF consists of two parts: an analytic function and a lookup
table of residuals to this function. Splitting the PSF in this fashion allows
for more accurate interpolation and representation of the PSF to arbitary
pixel centering. The analytic part of the PSF is numerically integrated to
high accuracy at any desired pixel centering, and the residuals are 
numerically interpolated and then added to the analytic function.

The choice of analytic function is set using the IPSFMODE option. The default
mode, IP=1, uses a Gaussian aligned along rows and columns of the image (but
with different FWHM in rows and columns). Other values of IPSFMODE are still
in test stage.

For use the the PSF fitting routines, it is often advantageous from the point
of computing speed to precompute the pixel-integrated PSF at a grid of 
subpixel locations, and then interpolate within this grid. Such a grid
can be created using the DAOLIB command, and then referenced during the
PSF-fitting routine using the IPSFMODE=0 option.

\section{PEAK: DAOPHOT PEAK Command} 
\begin{rawhtml}
<!-- linkto peak.html -->
\end{rawhtml}
\begin{command} 
  \item[Form: PEAK im\hfill]{} \end{command}

Fits stars in buffer im individually using specified PSF.

\section{NSTAR: DAOPHOT NSTAR Command}
\begin{rawhtml}
<!-- linkto nstar.html -->
\end{rawhtml}
\begin{command}
  \item[Form: NSTAR im  {[CLIP=nclip]}\hfill]{}
\end{command}

Fits stars in buffer im simultaneously using groups created by GROUP.
Requires an input PSF file and an input GROUP file, which will be prompted
for, or can be specified with the DAOFILES PSF=psffile GRP=grpfile
command. The output file can be given with the DAOFILES PRO=outfile
command, or it will be prompted for. The NCLIP= keyword allows the user to
set the number of iterations required in NSTAR before pixels which do not
seem to fit will have the weights reduced.  The standard value of NCLIP in
VISTA is 5. In Stetson's version of DAOPHOT, NCLIP effectively has the
value of 1 (although this may depend on the exact version of DAOPHOT).

\section{SUBSTAR: DAOPHOT SUBSTAR Command}
\begin{rawhtml}
<!-- linkto substar.html -->
\end{rawhtml}
\begin{command}
  \item[Form: SUB* im EXCLUDE=s1,s2,s3,...\hfill]{}
  \item[im]{specifies the buffer number for the image.}
  \item[EXCLUDE=s1,s2,... ]{  Will not subtract stars (s1,s2,s3,....) from
    the frame}
\end{command}

Subtracts stars from buffer \textit{im}. Requires
a PSF and a magnitude file, which will be prompted for or can be specified
with the DAOFILES PSF=psffile PRO=profile command. If the EXCLUDE= keyword
is specified, then the specified stars will NOT be subtracted.

\section{MONITOR/NOMONITOR: DAOPHOT MONITORING COMMANDS}
\begin{rawhtml}
<!-- linkto monitor.html -->
<!-- linkto nomonitor.html -->
\end{rawhtml}
\begin{example}
  \item[Form: MONITOR\hfill]{Turns on display of various information}
  \item[Form: NOMONITOR\hfill]{Turns off this display}
\end{example}

\section{SORT: Sort Two DAOPHOT Files}
\begin{rawhtml}
<!-- linkto sort.html -->
\end{rawhtml}
\begin{command}
  \item[Form: SORT {[INDEX=ind]} {[RENUM]} {[NORENUM]}\hfill]{}
\end{command}

Sorts a specified input DAOPHOT file by star number, X, Y positions,
magnitudes, etc. The index (column number) can be specified by the INDEX=
keyword, or it will be prompted for. Similarly, one can specify to have
(or not have) renumbering with the RENUM and NORENUM keyword, or it
will be prompted for. The command requires 2 file names, for the input
and output file.  They will be prompted for unless specified with the
DAOFILES FILE=infile FILE2=outfile command.

\section{OFFSET: Offset Positions in a DAOPHOT File}
\begin{rawhtml}
<!-- linkto offset.html -->
\end{rawhtml}
\begin{command}
  \item[Form: OFFSET {[im]} {[INV]} {[DX=dx DY=dy]}\hfill]{}
\end{command}

Shifts positions of all stars in a given file by a specified amount. The
amount can be specified with the DX= and DY= keywords, or else the program
will prompt the user for values. In addition, OFFSET has a new VISTA
function. If a buffer is specified with the OFFSET command, a linear plate
transformation will be performed from the header cards REF\_AX ... in the
specified header. These cards are automatically loaded into the header
using the REGISTER command, with the LOAD keyword. See REGISTER for more
information.  If INV is specified, the inverse transformation is done.

\section{SELECT: DAOPHOT SELECT Command}
\begin{rawhtml}
<!-- linkto select.html -->
\end{rawhtml}
\begin{command}
  \item[Form: SELECT {[SIZE=s1,s2]}\hfill]{}
\end{command}

Selects out groups of specified minimum and maximum size from a file
created by GROUP. The minimum and maximum sizes can be specified with the
SIZE= keyword. Requires an input and output file, which may be specified
with the DAOFILES FILE=infile FILE2=outfile command, or they will be
prompted for.

\section{APPEND: DAOPHOT APPEND Command}
\begin{rawhtml}
<!-- linkto append.html -->
\end{rawhtml}
\begin{command}
  \item[Form: APPEND\hfill]{}
\end{command}

Appends two DAOPHOT files. Requires 3 file names for 2 input files and 1
output file. These can be specified with the DAOFILES FILE=inputfile1
FILE2=inputfile2 FILE3=outputfile command or they will be prompted for.

\section{DAOSKY: DAOPHOT SKY Command}
\begin{rawhtml}
<!-- linkto daosky.html -->
\end{rawhtml}
\begin{command}
  \item[Form: DAOSKY im {[BOX=b]} {[3SIG]}\hfill]{}
  \item[im]{is the image number on which sky is to be determined}
  \item[BOX=b]{specfies VISTA box to do calculation in}
\end{command}

Returns DAOPHOT's estimate of the modal sky value, or alternatively, an
iterated, 3-sigma rejected mean if the 3SIG keyword is given.  It can be
instructive to compare these
with other VISTA estimates (
\htmladdnormallink{SKY}{sky.html}, 
\htmladdnormallink{WSKY}{wsky.html}).  It is hard to get a good sky value!

\section{DUMP: DAOPHOT DUMP Command}
\begin{rawhtml}
<!-- linkto dump.html -->
\end{rawhtml}
\begin{command}
  \item[Form: DUMP\hfill]{}
\end{command}

Dumps pixel values around a specified location. The command will ask for a
box size to dump (the maximum box size is 11), and a central pixel
location.

\section{AUTOMARK: Locate Stars Automatically in an Image}
\begin{rawhtml}
<!-- linkto automark.html -->
\end{rawhtml}
\index{Photometry!Locating stars}
\index{Stars!Locating on frame}
\begin{command}
  \item[Form: AUTOMARK imno {[RADIUS=rad]} {[RANGE=low,high]} {[REJECT=rej]}\hfill]{}
  \item{{[BOX=b]} {[NEW]} {[MOMENT=n]} {[EDGE=n]} {[SILENT]}}
  \item{{[ID=]} {[OBSNUM=]} {[DMIN=]} {[FORCE]} {[NITER=n]}}
  \item[imno]{is the image number on which stars are
to be found}
  \item[RADIUS=rad]{computes a centroid to locate each star
using a square of half-size 'rad'}
  \item[RANGE=low,high]{picks stars with peak counts between 'low' and 'high'}
  \item[REJECT=rej]{ignore stars that come within 'rad' of
ANY masked pixel}
  \item[BOX=b]{find stars in box 'b'}
  \item[NEW]{create a new list.}
  \item[MOMENT=n]{Specifies a new moment for the centroiding routine}
  \item[EDGE=n]{Only takes stars more than n pixels away from the edge of the frame}
  \item[SILENT ]{suppresses terminal output}
  \item[ID=id]{specifies DAOPHOT ID number to be associated with object}
  \item[OBSNUM]{specifies observation number to code into ID number}
  \item[DMIN=d]{specifies minimum distance an object needs to
lie from another to be judged a separate star}
  \item[FORCE]{forces all peaks to be marked as stars,
regardless of any nearby objects}
  \item[NITER=n]{specifies maximum number of iterations to try for
centroid. Default is 6.}
\end{command}

AUTOMARK finds objects on an image, storing their positions in a photometry
file.  It works this way: 
\begin{itemize}
  \item{the program first finds all local peaks in the image
   that have values between those given in RANGE.  }
  \item{at each of these peaks, it computes a centroid in a box
   of size (2 * rad - 1).  These centroids are the locations
   of the stars on the image.}
  \item{if this location falls within DMIN pixels of an already
           marked star, it is rejected. The default value for DMIN is 1.}
\end{itemize}
REJECT is used to reject stars that are near masked pixels.  See MASK for
instructions on masking pixels. RADIUS should be set to a value that is
near the FWHM of the stars in pixels.  REJECT should be at least 3 times
RADIUS.  REJECT=0 (or REJECT not given) means that stars will be found all
over the image.  Default values are RADIUS=2 and REJECT=0.

The centroiding algorithm will recompute the centroid using a shifted
region if the last centroid falls off the middle of the centroiding
region. If it does not converge within 6 iterations, it does not mark the
object. The maximum number of iterations can be changed with the NITER=n
keyword. Also, you can force the program to find something by using the
FORCE keyword, in which case the routine will use the last centroid
computed, regardless of whether it has converged or not - be cautious with
this!

Note that this program will find high points in an image which are not
stars.  It will center on galaxies, cosmic ray hits, etc.  The program was
designed for moderately crowded images with few defects -- images for which
the number of stars is much larger than the number of defects.  Use MASK to
mark cosmic ray hits, bad columns, galaxies, etc.

If no RANGE of peak values is given, the program will center on peaks with
heights between 0 and 1.0E10.  If only one value is given, it will find
peaks with values from that given upwards to 1.0E10.

AUTOMARK appends to the current photometry file, if there is one.  If the
keyword NEW is given, it creates a new list.

Object ID numbers which will be output into DAOPHOT files using the SAVE
DAO= or SAVE COO= command can be specified with the ID= or OBSNUM
keywords. Using ID=id associates the first detection with the number 'id',
then subsequent detections have 'id' incremented by one.  The observation
number (from the FITS header value OBSNUM) will be coded into the ID number
if the OBSNUM keyword is specified.

\noindent{Example: }
\begin{example}
  \item[AUTOMARK 2 RADIUS=2 REJECT=7 RANGE=300,30000\hfill]{
finds stars which have peak heights between 300 and 30000.  It 
considers a 5 by 5 box around each star, computing a centroid
in that box to locate the center.  Stars closer than 7 pixels
from masked pixels are rejected.}
\end{example}
A 'local peak' is defined as a pixel for which ALL 8 adjacent pixels (left,
right, top, bottom, and the 4 diagonals) have lower values.

Here is a procedure which masks pixels larger than a certain value, then
finds the stars.  This rejection of bright stars can be used to eliminate
saturated stars.  The program also masks the edge pixels so that stars too
close to the borders of the image are not found.

\begin{verbatim}
  PRINTF 'PROCEDURE FINDALLSTARS'                       ! PRINT HEADER.
  PRINTF 'THIS PROCEDURE FINDS ALL STARS ON AN IMAGE.'
  ASK         'USE WHICH IMAGE                             >> ' I
  ASK         'WHAT IS THE BRIGHT LIMIT FOR STARS          >> ' BRIGHT
  ASK         'WHAT IS THE FAINT  LIMIT FOR STARS          >> ' FAINT
  ASK         'AVOIDANCE RADIUS FOR MASKED/EDGE PIXELS     >> ' REJECT
  ASK         'RADIUS FOR COMPUTATION OF CENTROID          >> ' RAD
  STRING OPT '?TYPE NEW TO START A NEW LIST, OR HIT RETURN >> ' OPT
  UNMASK! CLEAR MASK LIST
  !  Insert here a call for masking pixels other than the edges.
  ER=SR[I]+NR[I]-1 EC=SC[I]+NC[I]-1                 ! FIND END ROW, COLUMN
  MASK R=SR[I] R=ER C=SC[I] C=EC                    ! MASK EDGES
  CLIP $I MASKONLY VMAX=BRIGHT                      ! MASK BRIGHT STARS
  AUTOMARK $I RADIUS=RAD REJECT=REJECT RANGE=FAINT,BRIGHT {OPT}
  END
\end{verbatim}


\section{MARKSTAR: Locate Stars Interactively in an Image}
\begin{rawhtml}
<!-- linkto markstar.html -->
\end{rawhtml}
\index{Photometry!Locating stars}
\index{Stars!Locating on frame}
\begin{command}
  \item[Form: MARKSTAR {[NEW]} {[RADIUS=r]} {[NOBOX]} {[STAR=s1,s2,...]}\hfill]{}
  \item{{[AUTO]} {[DR=dr]} {[DC=dc]} {[RSHIFT=rs]} {[CSHIFT=cs]} }
  \item{{[BOX=n]} {[COMPLETE]} {[ANGLE=a]} {[AR=ar]} {[AC=ac]}}
  \item{{[QUICK]} {[QSAVE]} {[EXIT]} {[CLR]} {[MOMENT=m]}}
  \item[NEW]{creates a new photometry file.}
  \item[RADIUS=r]{computes centroid in a box of half-size 'r'}
  \item[NOBOX]{do not display locations of stars}
  \item[STAR=s1,s2,...]{show location of individual stars}
  \item[AUTO]{use previous photometry file to compute new
positions.}
  \item[DR=dr]{new positions are about 'dr' in rows away
from the old positions (with AUTO only)}
  \item[DC=dc]{new positions are about 'dc' in columns away
from the old positions (with AUTO only)}
  \item[RSHIFT=rs]{ignore stars which are further away in rows
than 'rs' from the old position (with AUTO)}
  \item[CSHIFT=cs]{ignore stars which are further away in columns
than 'cs' from the old position (with AUTO)}
  \item[BOX=n]{Specifies size of boxes to draw on the TV}
  \item[COMPLETE]{For use with AUTO option, to force AUTOMARK to
find a new star for every object on the old list}
  \item[ANGLE=angle]{     For use with the AUTO options, to specify an image}
  \item[AR=row]{rotation, by the angle specified, around the row}
  \item[AC=col]{and column specified}
  \item[QUICK, QSAVE]{I forget what these do. Something quick. Check the code.}
  \item[EXIT]{Exit immediately after displaying stars. Do not
wait for more entries.}
  \item[CLR]{Clear the overlay (on devices with 7+1 bit display)
for whole image or around specified stars}
  \item[MOMENT=n]{Specifies moment for centroiding routine}
\end{command}


MARKSTAR creates a 'photometry file', which is a record of the positions,
coordinates, and magnitudes of stars on an image.  (See HELP PHOTOMETRY for
a complete list of entries in the photometry file).  Typing 'NEW' starts a
new list.  If you don't type 'NEW', any stars you mark will be appended to
the current list (if there is one); in this case the program will show the
positions on the TV of the stars that have already been marked -- after
this marking the program will be ready for you to enter new stars.  Thus
MARKSTAR with no options will show the positions of the stars in the
current photometry file.

There are two ways to operate this program.  The first mode lets you
interactively mark the positions of the stars.  The only keywords you need
in this mode are NEW and RADIUS=.
\begin{enumerate}
  \item{Load an image into the display with the TV command.}
  \item{Type MARKSTAR or MARKSTAR NEW (with a RADIUS specifier).}
  \item{Move the cursor near a star.}
  \item{Hit 'C' or 'J' to mark the star.
    The 'J' key defines the star's position to be exactly
    the location of the cursor.  The 'C' computes
    an exact position by finding the centroid of the
    stellar image.  You will probably use the 'C' key
    most of the time.  The 'J' key can be used in very
    crowded fields.  }
  \item{Repeat steps 3 and 4 until all the desired stars are found.
    At any time you may type 'H' to get a list
    of the commands for this program.}
  \item{Hit 'E' when you are finished.}
\end{enumerate}

In interactive mode, the key \# will display the number in the photometry
list of the star nearest the current location of the cursor, and print the
row and column location of that star.  This, combined with the STAR=
keyword (below) allows you to go back and forth between a list of star
positions and a TV image.

The second mode is to have the program mark all the stars that are on an
already-present photometry file.  This saves you time when you have several
exposures of the same field (say in several colors).  The syntax for the
second mode is MARKSTAR AUTO with the other options.  The program takes
each position on the current photometry photometry file, then looks at the
current TV image for a star.  If the star is found, the information is
stored on a new photometry list, REPLACING the old list.  (Save the old one
first!) If the stars on the new image are not exactly in the same positions
as on the old image, use DR and DC to specify the change that must be
applied to the old coordinates to match the new ones.  When the program is
finished marking the stars in this automatic mode, it switches to the
interactive mode, allowing you to mark more stars.  NOBOX prevents display
of the newly-marked stars. For images that are not just shifted, but also
rotated, you can specify the angle and center of rotation with the ANGLE,
AR=, and AC= keywords.

Use RSHIFT and CSHIFT to reject stars for which the AUTO marking gives a
new position far from the old one.  As MARKSTAR AUTO runs, it prints on the
screen the difference in position of stars on the new frame compared to the
EXPECTED positions on that frame.  This output may be redirected.

Do not confuse MARKSTAR AUTO with AUTOMARK.  AUTOMARK automatically finds
stars on a frame by locating peaks.  MARKSTAR AUTO finds stars on a frame
by referring to a photometry file.

The RADIUS specifier gives the size of the region used in computing the
centroid of the star.  It should be something like the FWHM of the star in
pixels.

The STAR= word is used to identify individual stars in a photometry file.
It draws a box around the stars whose numbers are given as arguments to
STAR=, then exits the program.  The word STAR= can appear more than once on
the command line.

\noindent{Examples: }
\begin{example}
  \item[TV 6\hfill]{}
  \item[MARKSTAR NEW RADIUS=2\hfill]{}
  \item[SAVE PHOT=./FIELDA\hfill]{
loads the image in buffer 6 into the TV.  MARKSTAR
then works on this image.  A new list is created.
After the stars are marked, the photometry file is
saved in the file ./FIELDA.PHO}
  \item[MARKSTAR\hfill]{
displays the current positions of the stars in the
photometry file on the TV.}
  \item[TV 6 \hfill]{}
  \item[MARKSTAR NEW RADIUS=2\hfill]{}
  \item[SAVE PHOT=./BLUE\hfill]{}
  \item[TV 7\hfill]{}
  \item[MARKSTAR AUTO DR=-0.5 DC=0.5 RADIUS=2\hfill]{}
  \item[SAVE PHOT=./RED\hfill]{ This is an example of marking two exposures
       of the same field.  The first three commands find the positions of
       the stars on image 6, just as in the first example.  The positions
       are saved in the file ./BLUE.PHO.  Then image 7 is loaded into the
       TV.  MARKSTAR AUTO takes the positions in the current file, adds
       -0.5 to each row and 0.5 to each column. It then goes through these
       positions, computing the centroid for the stars there.  The
       resulting file is saved in ./RED.PHO.}

  \item[PRINT PHOT BRIEF $>$phot.txt\hfill]{}

  \item[MARKSTAR STAR=5,13,206,1107\hfill]{ which outputs a short version
       of the photometry file to the ASCII file phot.txt which may then be
       printed or edited (see HELP PRINT for information).  MARKSTAR STAR=
       then draws boxes around the star \# 5, \#13, etc.}
\end{example}

You can print the contents of a photometry file with the PRINT command.
Type 'PRINT PHOT' to see the results on your terminal; type 'PRINT PHOT
HARD' to send them to the lineprinter.

It is best to create a new photometry file for each image you reduce.  That
way there is a one-to-one match between images and files.  You do not have
to include all the stars in a frame in a photometry file, if you do not so
desire, but you are asking for trouble if you have information from several
frames in the same file.

The variables R and C are loaded with the position of the last star marked.

MARKSTAR AUTO is most useful to mark a series of images that are very
similar -- say exposures of the same duration and in the same color.
Images of different duration, or images in different colors will reach to
different magnitudes.  In this case AUTOMARK applied to each frame may be
the best.

To find the coordinate offset between different frames, use MARKSTAR on one
frame to locate a few bright, uncrowded stars.  Then use MARKSTAR AUTO on
the second frame.  The program will print the difference in location
between the star on the second frame and that on the first, then print the
average row and column shift.  These differences are in the sense: 
\begin{verbatim}
   SHIFT = (new position) - (old position)
\end{verbatim}
So the shift would be applied to the first image to bring them into
alignment.

\section{APERSTAR: Measure Brightnesses by Circular Aperture Photometry}
\begin{rawhtml}
<!-- linkto aperstar.html -->
\end{rawhtml}
\index{Stars!Aperture photometry}
\index{Aperture photometry}
\begin{command}
  \item[Form: APERSTAR source STAR=rs SKY=r1,r2 {[SKY=NONE]} {[GAIN=g]} {[RONOISE=r]} {[REJECT=sig]}\hfill]{}
  \item[source]{is the image being measured}
  \item[STAR=rs]{measures the total counts for each star.
An aperture of radius rs pixels is used.}
  \item[SKY=r1,r2]{An annulus of inner radius r1 and outer
radius r2 is used to measure the sky brightness}
  \item[SKY=NONE]{assumes the sky is zero.}
  \item[GAIN=g]{specifies the gain of the CCD in photons/count}
  \item[RONOISE=r]{specifies the read-out noise of the CCD in rms COUNTS.}
\end{command}

APERSTAR estimates the brightness of each star on a photometry file using
aperture photometry.  The brightness is the sum of the counts within a
specified radius around each star, with the sky estimated by the mean level
of counts in an annulus around the stars. APERSTAR performs the same task
as the DAOPHOT 
\htmladdnormallink{PHOTOMETRY}{photom.html} routine, 
but the latter probably does a better
job and is recommended for most occasions.

There are three steps to measuring stellar brightnesses using
APERSTAR. First locate the stars you want to be measured using AUTOMARK or
MARKSTAR.  Then measure the brightness using APERSTAR.  Finally, save the
results to disk using SAVE PHOT or print then using the command PRINT PHOT.

You MUST specify the radius of a stellar aperture, and the radii of an
annulus used to estimate the sky.  The inner radius of the sky annulus must
be larger than the radius of the star aperture. The sky radii must differ
by at least 2.  Exception: if you give the word SKY=NONE, the sky value is
assumed to be 0.0.  This allows you to determine the sky value globally for
the image (using the SKY program), then having all stars measured with the
same sky level. If SKY=NONE is not given, the sky level is estimated for
each star.

The algorithm for determining the sky level works like this: The MEAN and
standard deviation of the intensities is measured in a first pass. Those
pixels which differ from the mean by four times the standard deviation are
then excluded from the list, and the mean level computed again.  This mean
is taken as the sky brightness.  The brightness of the star is then the sum
of (pixel - sky) for all pixels in the star's aperture.  The rejection
level can be changed from 4-sigma to a user specified value using
REJECT=sig, which gives the number of sigma objects to reject.

A similar program is APER, which measures the brightness of an single
object using a series of apertures.  Also see PROFILE or PRAD, which
measure the radial profile of objects on a frame.

\noindent{Examples: }
\begin{example}
  \item[APERSTAR 5 STAR=6 SKY=8,10 GAIN=10.5 RONOISE=8.57\hfill]{
This finds the brightness of all stars on image 5 which
have been marked in the photometry file with MARKSTAR 
or AUTOMARK.  Each brightness is computed in a circle of
radius 6 pixels, with the sky being computed using those
pixels from 8 to 10 pixels from the center of each star.
The errors are computed using a gain of 10.5 photons/count,
with a readout noise of 8.57 counts rms.}
\end{example}

\section{COORDS: Compute Celestial Coordinates for Stars}
\begin{rawhtml}
<!-- linkto coords.html -->
\end{rawhtml}
\index{Stars!Positions}
\index{Stars!Coordinates}
\index{Photometry!Coordinates of stars}
\begin{command}
  \item[Form: COORDS {[output redirection]}\hfill]{}
\end{command}

COORDS finds the right ascension and declination for each star in a
photometry file.  At least three of the stars must have had their R.A. and
Declination. entered in MARKSTAR or in MODPHOT.  The coordinates for the
standards must all be at the same epoch. (One day we will have a precession
program.)

COORDS works by solving a least-square relation between the rectangular
coordinates on the image (i.e., row and column) and the spherical
coordinates on the sky. The program calculates the coordinates for every
star in the photometry file based on the standard positions you have
entered, including the standard stars. The input positions, calculated
positions, and difference in seconds of time for the standards will be
displayed on your terminal. The program will then print the positions of
the standards.

The difference between the input and the calculated positions should be
small and evenly distributed about zero. If not, one or more of your input
coordinates is possibly wrong.  Use MODPHOT to change that coordinate, and
try again.  Note that the difference is in seconds of arc for both the
declination and the right ascension.

If you want to save the coordinates computed by the MODPHOT command, you
must use the 'SAVE PHOT=filename' command.

The output of COORDS can be redirected.  See HELP REDIRECT for information
about the redirection mechanism.

\section{MODPHOT: Modify Entries in a VISTA Photometry File}
\begin{rawhtml}
<!-- linkto modphot.html -->
\end{rawhtml}
\index{Photometry!Modifying files}
\index{Photometry!Entering data}
\begin{command}
  \item[Form: MODPHOT\hfill]{}
\end{command}

MODPHOT allows you to change records in a photometry file. The program asks
for the number of the record being changed. You can enter or change
coordinates or identifying labels.  You can also delete records. You should
use the command 'PRINT PHOT' (which can be redirected) to get a list of the
record numbers before you call MODPHOT.

A word of warning: The program renumbers the photometry records if any are
deleted.  So if you, for example, delete record 17, number 18 becomes 17,
19 becomes 18, etc.

If you want to save changes made by the MODPHOT command, you must use the
'SAVE PHOT=filename' command.

\section{SHORTAP: Convert DAOPHOT Aperture Photometry Files to NSTAR Files}
\begin{rawhtml}
<!-- linkto shortap.html -->
\end{rawhtml}
\begin{command}
  \item[Form: SHORTAP {[AP=nap]}\hfill]{}
\end{command}

SHORTAP prompts the user for the name of an input aperture photometry file
and an output file. It simply reads in the aperture magnitudes and outputs
an NSTAR-like file, using the first aperture magnitude, or one of the users
choice if the AP=nap keyword is given.

\section{COMBINE: Combine Photometry Files using Magnitudes and/or 
        Distances}
\begin{rawhtml}
<!-- linkto combine.html -->
\end{rawhtml}
\begin{command}
  \item[Form: COMBINE {[REF=file]} {[DAT=file]} {[CMB=file]} {[MER]} {[COMB]}\hfill]{}
  \item{{[SKY=sky]} {[RN=rn]} {[GAIN=gain]} {[NEFF=neff]}}
  \item{{[FACT=fact]} {[NORM=norm]} {[REFMAG]} {[SILENT]} {[PLOT]} {[PORT]}}
  \item{{[HARD]} {[MAG=dm]} {[DIST=dist1,dist2,...]} {[DR=dr]} {[DC=dc]}}
  \item{{[SIG=sig]} {[MEAN=mean]} {[NMAT=nmat]} {[REF]} {[COO]}}
\end{command}

COMBINE takes a reference file and a data file, both in DAOPHOT style, and
merges them, matching stars by position and magnitude. There are two main
modes. The first produces a .MER file which has the magnitudes from both
frames, the difference, and lots of other informations. The second mode,
used when the CMB= keyword is used, produces a file which has the positions
and magnitudes of both frames. This file can be rerun through COMBINE to
add more frames. This is used to combine multiple observations of a given
set of stars. The first mode is useful only for comparing 2 frames. It is
largely historical.

It is strongly suggested that both files be sorted from brightest to
faintest before running. Files can be specified by REF=file and DAT=file,
or will be prompted for. They must have star number, column position, row
position, and brightness in the first 4 columns. The brightness will be
assumed to be in magnitudes if the file has extension .NST, .TST., or .COM,
or if the keyword REFMAG is specified.

Stars will be based on a matching criteria of magnitudes and/or distance,
with the maximum magnitude difference specified by MAG=maxm and the maximum
position difference by DIST=maxd. Either criterion can be shut off by
supplying a very large value. The defaults are infinity magnitudes and
1. pixel for maxm and maxd. Several passes may be made through the
reference with successively less stringent matching criteria in distance by
specifying several distance criteria with the DIST=d1,d2,... keyword.
   
If the REF keyword is specified, the coordinates of objects in each frame
will be transformed according to transformations loaded in the header using
the REGISTER command. Alternatively, use the OFFSET command to transform
the coordinates before running COMBINE.

The output in the first mode is a .MER file with a variety of information, 
as follows, by column: 

\begin{center}
Contents of the .MER File: \\
\begin{tabular}{|cl|cl|}
\hline
Column&Parameter&Column&Parameter\\
\hline
1 & True mag  & 9 & $-$2 sigma           \\
2 & Obs mag   & 10& true frac dist       \\
3 & diff      & 11& obs. magnitude error \\
4 & obs. row  & 12& position error       \\
5 & obs. col  & 13& chi                  \\
6 & true cnts & 14& sharp                \\
7 & true S/N  & 15& niter                \\
8 & $+$2 sigma& 16& DAOPHOT star number  \\
\hline
\end{tabular}
\end{center}

To do the noise estimates properly, one must specify the sky value with
SKY=, gain with GAIN=, readout noise(electrons) with RN=, NEFF=. To
accommodate tests with the same reference file at various levels, we have
the keywords FACT=f, which specifies a multiplier to be applied to the
reference counts, and NORM=n, which specifies a 0 point. These default to 1
and 0 (for DAOPHOT magnitudes), respectively.

With the COMB or COMB= option, we will produce a new version of the
reference file, with additional columns for matched information from the
data file. This can be rerun through COMBINE as the reference file to get
yet another set of matched observations, etc., up to six times.

With the PLOT option, will produce a plot of REF MAG vs. DELTA MAG and a
histogram of matched and unmatched stars as a function of magnitude. With
the MER option, this plot is made directly from a previously existing .MER
file, if the matching has already been done previously (e.g., in batch).

\section{MAGAVER: Compute Weighted Means of Photometry from COMBINE}
\begin{rawhtml}
<!-- linkto magaver.html -->
\end{rawhtml}
\begin{command}
  \item[Form: MAGAVER {[NORM]} {[PLOT]} {[TTY]} {[NOSHIFT]} {[FILTER=]}\hfill]{}
\end{command}

MAGAVER takes the output file from COMBINE when run with the CMB=
option. It will ask the user which columns in this file correspond to which
colors, and will do a weighted average of multiple observations in each
color. Currently, only 3 different colors are allowed.  If the PLOT keyword
is specified, the magnitudes to be averaged will be displayed with a MONGO
plot for each star. If the TTY keyword is specified, the user will be
allowed to interactively remove points from each set of observations.

This command can also be used on output photometry files to merge them
together into one file, for later use by FITSTAR.  In this mode, the
program will prompt for a file name, read the stars in from this file and
output them to a new file, then ask for a new input file, from which to
append the results onto the original output file. This can be used, for
example, to merge all observations of standard stars from multiple frames
into one file.  The NORM keyword will normalize all the measured magnitudes
to a standard exposure time, assuming the exposure is stored in the data
file.

\section{REGISTER: Compute a Linear Plate Solution Between Several Images}
\begin{rawhtml}
<!-- linkto register.html -->
\end{rawhtml}
\begin{command}
  \item[Form: REGISTER {[im1,im2,im3...]} {[LOAD]} {[HEADER]} {[NOMEAN]}\hfill]{}
\end{command}

REGISTER solves for the coefficients of a linear plate transformation given
the positions of at least 3 stars appearing in all the frames
concerned. The plate transformation is of the form:
\begin{verbatim}
   X(REF) = X(PLATE) + AX*X(PLATE) + BX*Y(PLATE) + CX
   Y(REF) = Y(PLATE) + AY*X(PLATE) + BY*Y(PLATE) + CY
\end{verbatim}
The reference frame is taken to be the first frames specified, but shifted
in rows and columns so that the positions of the reference stars average to
0; if the NOMEAN keyword is used, then the first frame will be the
reference frame, with no shift at all ( this should be the default, but
isn't for historical reasons - this may change someday ...)

If the HEADER option is specified, the stellar positions are read from the
image header in cards(RSTARX1,RSTARY1),(RSTARX2,RSTARY2), (RSTARX3,RSTARY3)
... up to a maximum of 9 stars.  These cards can be placed in the header
using the MARKSTAR command specifying a buffer number and the keyword
REF. If the HEADER option is not used, the program will prompt for two
files containing the stellar positions in each of two frames. In this case,
only 2 frames can be done at a time.

If the LOAD keyword is specified, then the coefficients of the fits are
loaded into each header in the cards REF\_AX, REF\_BX, REF\_CX, REF\_AY,
REF\_BY, and REF\_CY.

\section{FITSTAR: Calculate Extinction and Transformation Coefficients}
\begin{rawhtml}
<!-- linkto fitstar.html -->
\end{rawhtml}
\begin{command}
  \item[Form: FITSTAR or FIT* {[AIR=]} {[HJD=]} {[COL=]} {[NOPLOT]} {[HARD]} {[HARD=]}\hfill]{}
  \item{{[PS=]} {[TITLE]} {[TITLE=]} {[RES]} {[RES=]} }
  \item{{[OUT=]} {[LOCK=]} {[OBSNUM=]} {[OBSNUM2=]}}
  \item{{[NOOBSNUM]} {[ERRMIN=]} {[STNERR=]} {[AP=]} {[APCOR=]}}
  \item{{[STN=]} {[DAT=]} {[SCOL=]} {[BATCH]} {[NEW]} {[NOPLOT]} }
\end{command}

FITSTAR determines extinction and/or transformation coefficients given
observations of standard stars along with known standard magnitudes and
colors for these stars. Currently, up to five terms are available for the
full transformation equation for each color: 

\begin{enumerate}
  \item{first order extinction}
  \item{second order extinction}
  \item{color transformation}
  \item{time term (by Julian date)}
  \item{constant term}
\end{enumerate}

FITSTAR will by default perform a fit without a second order term or a time
term. Residuals will be displayed as a function of airmass, color,
color*airmass, and Julian date; note that these are residuals after the
best fit has been subtracted. The user then has the option of deleting
individual points from the fit, and also of allowing for a second order or
time term, or locking the value of any of the terms at any desired
value. This is accomplished generally by allowing the user to lock any of
the five parameters. Thus, transformations for extinction or color terms
alone are easily obtainable. After allowing for the addition or deletion of
new parameters and the possible deletion of bad points, a final plot of the
residuals of the fit is made as a function of standard magnitude.

Two input files are required for FITSTAR. The first is a file of standard
magnitudes and colors. The format is a header line with the number of
colors and the color names, followed by a line for each star with the
appropriate standard magnitudes.  The magnitudes should be followed by an
exclamation mark (!)  and an optional star ID and star name. If a star ID
number is given after the !, all observations with this ID number are
assumed to be observations of this standard star. If no number is given,
the user will be prompted to enter the data ID number for each standard
star. IMPORTANT: all standard star numbers should have values less than
1000. This allows use of the OBSNUM option, in which the observed star
numbers have ID = 1000*STANDARD ID + OBSNUM, allowing multiple observations
of the same star to have unique ID numbers. By default, VISTA will
recognize this convention; if you do not wish to use this convention and
also want to have star numbers greater than 1000, use the NOOBSNUM
keyword. The OBSNUM=n keyword allows the user to change the default
switch-over point from 1000 to another value. The OBSNUM2=n allows a
similar function, but with a reversed definition: ID = n*OBSNUM + STANDARD
ID

By default, the program will search the VISTA default DATA directory for
the standards file.  The standards file can be specified on the command
line with the STN=file keyword.

The second file which is required is one which contains the measured 
instrumental magnitudes, airmasses, etc.
All observations should be combined into one .mag file, using the MAGAVER
command, before running FITSTAR. It is assumed that all observations of a
given star will have the same ID number.  The program first searches the
VISTA default PHOTOMETRY directory for this data file. The data file can be
specified on the command line with the DAT=file keyword. Note that the .mag
file contains airmasses for your observations; to get good solutions, these
airmasses must be correct! For default xvista behavior, airmasses are
computed from the coordinates and time of observation, which requires that
the longitude and latitude be known. See the SETUP command for how to
modify these and/or check the computed values against precomputed values 
which may exist in the image headers. Airmasses are loaded for stellar
photometry files when the MARKSTAR or AUTOMARK command is used.

The specific transformation equation(s) that will be determined
has the form: 
\begin{verbatim}
   mag(corrected) = mag(raw) + z(1)*(airmass-air0)
                             + z(2)*(airmass-air0)*(color-col0)
                             + z(3)*(color-col0)
                             + z(4)*(hjd-hjd0)
                             + z(5)
\end{verbatim}
where FITSTAR solves for some or all of the Z coefficients. The airmass,
color, and Julian date offsets can be specified using the AIR=, COL=, and
HJD= keywords, otherwise they default to 0, except for the HJD parameter
which defaults to the midpoint of the observations.  It can be useful to
set these values to values that fall in the mid-range of your observed
values to prevent fits for one coefficient having undue leverage on the
fits for the other coefficients. Many people like to refer their airmasses
to AIR=1.  If you use the Julian date term, you almost certainly want to
set HJD0 to fall in the middle of your observed Julian dates (note that for
this routine, Julian date actually means Julian date - 2444000). Generally,
however, the defaults work just fine.
 
FITSTAR will write an output file with default extension (.trn).  You can
override this default file name with the OUT=file keyword.  This file will
contain one header line which labels the columns, then a line for each
transformation equation that you have determined. Note that each run of
FITSTAR will add one line to the (.trn) file.  On subsequent runs, if you
specify the same (.trn) output file, the new transformation equations will
be appended to the old file.  You can force a new file to be opened by
using the NEW keyword. Each line in this file will contain 8 numbers and 2
character strings with the transformation info: z(1) z(2) z(3) z(4) z(5)
air0 col0 hjd0 magname colname (see the equation above for the description
of these terms).  This file will be used by the CORRECT command to correct
stellar magnitudes or PROFILE photometry.

Normally, FITSTAR runs in an interactive mode to allow you to delete stars
and/or lock parameters. It can be run in "batch" mode, however, if you
specify the BATCH keyword, then all points will automatically be
accepted. You can lock parameters on the command line using the
LOCK=n{[,val]} keyword. If the first argument is greater than 0, then that
parameter is locked to the valued of the second argument, or to 0 if no
second argument is given.  If the first argument is negative, then that
parameter is unlocked.  The standard magnitude and color columns to use can
be specified on the command line using the SCOL=mag,col1,col2 keyword,
where the 3 values are the same numbers that would have been entered
interactively.

Hardcopy options are available with the HARD, HARD=, and PS= keywords. With
the HARD copy, both plots will automatically be sent to the printer after
you're finished deleting stars and changing parameters. With HARD=n, where
n=1 or 2, you can just have one of the two plots sent to the printer. IF
the PS=file option is given, the plots will be written to the specified
file instead of to the printer; with this option, the first plot will have
the character 'a' appended to the specified name, and the second will have
the character 'b' appended.

The output plots can be labeled using the TITLE or TITLE= keyword; the
former will prompt the user for a title string.
  
The NOPLOT option can be used to suppress the making of plots entirely,
useful e.g. if you're not on a graphics terminal.

The RES and RES= keywords can be used to output individual star residuals,
along with the input data information and the standard magnitude and color
to an output file.

The STNERR=x keyword can be used to assign a single error to be used to for
all of the STANDARD magnitudes if desired. (The observed errors are taken
from the input data file). The default for STNERR is to assume standards
are all very accurate, with STNERR=0.001. This parameter will really only
affect the determined value of CHI2.
 
Finally, the APCOR=x keyword can be used to apply a single aperture
correction in magnitudes to apply to all of the input data; the default is
not to apply an aperture correction. If you use APCOR, the value you use
will be printed on the summary output page. In addition, solely for output
purposes, you can specify the aperture used with the AP= keyword; this will
just be echoed on the output summary page.

\section{CORRECT: Correct Photometry for Extinction and/or Transformations}
\begin{rawhtml}
<!-- linkto correct.html -->
\end{rawhtml}
\begin{command}
  \item[Form: CORRECT  {[BIN=bin]} {[PROF]} {[TRN=trnfile]} {[MAG=magfile]}\hfill]{}
  \item{{[LINE=line]} {[COLOR=color]} {[COLCOL=c1,c2]}}
  \item[BIN=bin]{specifies if a binning factor was used
for observations but not for standards}
  \item[PROF]{corrects PROFILE common block rather than stellar photometry file}
  \item[TRN=trnfile]{specifies name of transformation file}
  \item[MAG=magfile]{ specifies name of file with magnitudes}
  \item[LINE=line ]{specifies which transformation line to use}
  \item[COLOR=color]{specifies standard color to use in
transformation equation if you only have observations in one color}
  \item[COLCOL=c1,c2  ]{  specifies the 2 observed color columns to 
use in transformation if you have observations in more than one color}
\end{command}


CORRECT applies photometric corrections to raw data to account for
extinction and/or transformation terms.  It can act either on a number of
types of stellar photometry files (e.g. standard DAOPHOT files or files
that come from the MAGAVER| command), or internally on the surface
brightnesses and magnitudes in the internal PROFILE common block. Besides
the input data, the routine reads a file with the extinction and
transformation coefficients. This file may be created using the FITSTAR
command, or for more simple cases in which you wish to dictate the
extinction and/or transformation coefficients, it may be created by the
user by hand. See the FITSTAR help file for a description of this
transformation (.trn) file.

When you run CORRECT, the routine will prompt for a transformation file
name, unless you supply one with the TRN=trnfile keyword.  It will list the
various lines in this file and ask you which transformation you wish to
use; alternatively, you can pre-specify the line to use with the LINE=
keyword. If you have observations in more than one color (in MAGAVER
files), you will be asked which magnitude you wish to correct, and which
colors to use for the color terms (or you can specify these with the
COLCOL= keyword).  If you have observations in only one color, you will be
asked if you wish to enter a standard color to use in the transformation
equations, unless you have pre-specified this number using the COLOR=
keyword. The routine will then proceed to apply the transformation
equation(s).

If you are correct stellar magnitudes, you will be prompted for an input
and output file name.  If you are using the PROF option, the internal
counts in the PROFILE common block will be corrected.  The reduced PROFILE
counts (or magnitudes) can be seen using the PRINT PROF {[MAG]}
command. With the PROF option, several auxiliary value are computed, namely
the concentration index (ratio of radii that include 25 and 75 percent of
the light), the total magnitude (extrapolated for an exponential disk if
one has been fit using the CPROF command), and the disk-to-total light
ration (using the exponential fit if done). These values are loaded into
the internal PROFILE FITS header, and also printed out with the PRINT PROF
command.

NOTE: For the PROF option, the counts will be corrected for exposure time
and the airmass computed. This requires that accurate values for EXPOSURE,
RA, DEC, DATE-OBS, and the latitude are available. Since the PROFILE header
is originally copied from the image header, these values should be
available. If they are not, note that cards can be added and/or removed
from the internal PROFILE header using the FITS, UNFIT, or HEDIT command
with the PROF keyword instead of a buffer number.

\section{DAOFILES: Define Names of DAOPHOT Files for DAOPHOT Commands}
\begin{rawhtml}
<!-- linkto daofiles.html -->
\end{rawhtml}
\begin{command}
  \item[Form: DAOFILES {[COO=file]} {[MAG=file]} {[PSF=file]} {[PRO=file]}\hfill]{}
  \item{{[GRP=file]} {[FILE=file]} {[FILE2=file]} {[FILE3=file]} {[NONE]}}
\end{command}

DAOFILES tells DAOPHOT what files to use at its various stages of
execution. If the keyword NONE is specified, everything is reset so that
DAOPHOT will always prompt for file names, as it always does outside of
VISTA.

\section{AUTOCEN: Find the Center of an Extended Object}
\begin{rawhtml}
<!-- linkto autocen.html -->
\end{rawhtml}
\begin{command}
  \item[Form: AUTOCEN buf {[N=n]} {[SIZE=n]} {[STEP=n]} {[C=(r,c)]} 
       {[PLOT]}\hfill]{}
\end{command}

AUTOCEN attempts to find the center of an extended and possibly amorphous
object by use of reflected autocorrelation.  It is designed for objects
like globular clusters. For smooth objects, the AXES command is better. The
routine works by calculating a set of correlation amplitudes about an
estimated image center. Amplitudes are measured on an N X N grid with
sampling taken at STEP spacing in pixels. At each sample point the mean is
calculated in a SIZE X SIZE pixel cell, and is subtracted in calculations
of the autocorrelation amplitude, which is calculated by the product of the
cell with its image reflected about its center. The default values for N,
SIZE, and STEP are 7, 75, and 4. The final center is calculated by fitting
a paraboloid to the grid of amplitudes. The results are saved in the VISTA
variables AXR and AXC, and in the AXES common block.  If the PLOT keyword
is specified, a cross is marked at the determined center on the TV image.

See Also: AXES
